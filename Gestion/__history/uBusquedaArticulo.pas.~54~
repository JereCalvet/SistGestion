unit uBusquedaArticulo;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, uBusquedaGenerica, Data.DB, Vcl.Grids,
  Vcl.DBGrids, Vcl.StdCtrls, Vcl.Buttons, Vcl.WinXCtrls, dxGDIPlusClasses,
  Vcl.ExtCtrls;

type
  TfrmBusquedaArticulo = class(TfrmBusquedaGenerica)
    procedure FormShow(Sender: TObject);
    procedure srchbx1InvokeSearch(Sender: TObject);
    procedure srchbx1KeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure btnCancelarClick(Sender: TObject);
  private
    RegInicial: string;
    Cancelar: Boolean;
    { Private declarations }
  public
    { Public declarations }
  end;

var
  frmBusquedaArticulo: TfrmBusquedaArticulo;

implementation

uses
  udmGestion;

{$R *.dfm}

procedure TfrmBusquedaArticulo.btnCancelarClick(Sender: TObject);
begin
  Cancelar := True;
  inherited;
end;

procedure TfrmBusquedaArticulo.FormClose(Sender: TObject;
  var Action: TCloseAction);
begin
  inherited;
   with dmGestion do
     begin
        if not(fdqryMDMovimientosRanged.State = dsEdit) or not(fdqryMDMovimientosRanged.State = dsInsert) then
           fdqryMDMovimientosRanged.Edit;
        if (Cancelar = True) or (fdqryArticulos.IsEmpty) then                   // not(fdqryArticulos.IsEmpty)
           begin
             fdqryArticulos.Locate('CODIGO', RegInicial, []);       //devuelve el puntero articulos a su posicion original
             ShowMessage('pos inicial: '+RegInicial+', Cancelar: '+BoolToStr(Cancelar, True));
           end
        else
           fdqryMDMovimientosRanged.FieldByName('FK_COD_ART').Value := fdqryArticulos.FieldByName('CODIGO').Value;
        fdqryArticulos.Filtered := False;
        if (fdqryMDMovimientosRanged.State = dsEdit) or (fdqryMDMovimientosRanged.State = dsInsert) then
           if fdqryMDMovimientosRanged.FieldByName('FK_COD_ART').Value <> Null then
              fdqryMDMovimientosRanged.Post
           else
              fdqryMDMovimientosRanged.Cancel;
        fdqryArticulos.Filter := '';
        Cancelar := False;
     end;
end;

procedure TfrmBusquedaArticulo.FormShow(Sender: TObject);
begin
  inherited;
  Cancelar := False;
  lblTitulo.Caption := 'Artículos';
  RegInicial := dsBase.DataSet.FieldByName('CODIGO').Value;
end;

procedure TfrmBusquedaArticulo.srchbx1InvokeSearch(Sender: TObject);
begin
  inherited;
  with dmGestion do
    begin
       fdqryArticulos.FilterOptions := [foCaseInsensitive];
       fdqryArticulos.Filter := 'NOMBRE LIKE' + QuotedStr('%'+srchbx1.Text+'%')+' OR '+'CODIGO LIKE ' + QuotedStr(srchbx1.Text+'%')+' OR '+'CODIGOALT LIKE ' + QuotedStr(srchbx1.Text+'%');
       fdqryArticulos.Filtered := True;
       //el caracter ' me da error de filtro, nose puede filtrar por codigo ---fdqryArticulos.Filter := 'NOMBRE LIKE' + QuotedStr('%'+srchbx1.Text+'%')+' OR '+'CODIGO LIKE ' + QuotedStr(srchbx1.Text+'%')+' OR '+'CODIGOALT LIKEA ' + QuotedStr(srchbx1.Text+'%');
    end;// 'NOMBRE LIKE' + QuotedStr('%'+srchbx1.Text+'%');
end;

procedure TfrmBusquedaArticulo.srchbx1KeyUp(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  inherited;
  with dmGestion do
    begin
       if srchbx1.Text = '' then
          begin
            fdqryArticulos.Filter := '';
            fdqryArticulos.Filtered := False;
          end
       else
          srchbx1.OnInvokeSearch(Self);
    end;
end;

end.
